mapImage.onload = () => {
  mapReady = true;
  drawInitialMap();

  if (!navigator.geolocation) {
    alert("このブラウザは位置情報（GPS）に対応していません。\n別のブラウザやスマートフォンでお試しください。");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const { latitude, longitude } = pos.coords;
      drawWithGPS(latitude, longitude);
    },
    (err) => {
      let message = "位置情報の取得に失敗しました。";

      switch (err.code) {
        case err.PERMISSION_DENIED:
          message += "\n位置情報の使用が拒否されました。\nブラウザ設定で位置情報を許可してください。";
          break;
        case err.POSITION_UNAVAILABLE:
          message += "\n位置情報が利用できません。";
          break;
        case err.TIMEOUT:
          message += "\n位置情報の取得がタイムアウトしました。";
          break;
        default:
          message += `\nエラーコード: ${err.code}`;
      }

      alert(message);
    }
  );
};

